<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_8821_glide_utils.makeItem</api_name>
        <client_callable>true</client_callable>
        <description/>
        <name>makeItem</name>
        <script><![CDATA[var makeItem = Class.create();
makeItem.prototype = Object.extendsObject(global.AbstractAjaxProcessor, {
	_callViaREST:function (restObj){
		var returnObj = {};
		var restMessage = new sn_ws.RESTMessageV2();
		restMessage.setBasicAuth('admin','admin');
		restMessage.setHttpMethod(restObj.method);
		restMessage.setEndpoint(restObj.endpoint);
		restMessage.setRequestBody(JSON.stringify(restObj.requestBody));
		var response = restMessage.execute();
		var error = response.haveError();
		if(error){
			var errorCode = response.getErrorCode();
			var errorMsg = response.getErrorMessage();
			returnObj.errorCode = errorCode;
			returnObj.errorMsg = errorMsg;
		} else {
		}
		var headerVal = response.getHeader("Content-Type");
		var headers = response.getHeaders();
		var queryString = response.getQueryString();
		var statusCode = response.getStatusCode();
		var responseBody = response.getBody();
		returnObj.statusCode = statusCode;
		returnObj.responseBody = JSON.parse(responseBody).result;
		return returnObj;
	},
	createItem: function(itemObj){
		try {
			var returnObj = {
				"_status": "started",
				"_sysparm_obj": this.getParameter('sysparm_obj')
			};
			var clientObj = JSON.parse(this.getParameter('sysparm_obj'));
			var instanceGR = new GlideRecord('sys_update_set_source');
			if(instanceGR.get(clientObj.instance)){
				var instance = instanceGR.getValue('url').split('.')[0].split('https://')[1];
				var endpoint = "http://"+ instance +".service-now.com/";
				endpoint += "api/now/table/sc_cat_item";
				var item = this._callViaREST({
					method: "post",
					endpoint: endpoint,
					requestBody: {
						name: itemObj.name,
						category: itemObj.category,
						catalog: itemObj.catalog
					}
				});
				
			}
		} catch (e) {
			return JSON.stringify(e);
		}
	},
	createUpdateSet: function(){
		try {
			var returnObj = {
				"_status": "started",
				"_sysparm_obj": this.getParameter('sysparm_obj')
			};
			var clientObj = JSON.parse(this.getParameter('sysparm_obj'));
			var instanceGR = new GlideRecord('sys_update_set_source');
			if(instanceGR.get(clientObj.instance)){
				var instance = instanceGR.getValue('url').split('.')[0].split('https://')[1];
				var endpoint = "http://"+ instance +".service-now.com/";
				endpoint += "api/now/table/sys_update_set";
				var gdt = new GlideDateTime();
				var date = gdt.getDisplayValue().split(' ')[0];
				var response = this._callViaREST({
					method: "post",
					endpoint: endpoint,
					requestBody: {
						name: date + ' ' + clientObj.name
					}
				});
				returnObj = response.responseBody;
				/*this.createItem({
					name: clientObj.name,
					catalog: clientObj.catalog,
					category: clientObj.category,
					variables: clientObj.variables
				});*/
			}
			return JSON.stringify(returnObj);
		} catch (e) {
			return JSON.stringify(e);
		}
	},
	getCatalogs: function() {
		try {
			var returnObj = {
				"_status": "started",
				"_sysparm_obj": this.getParameter('sysparm_obj')
			};
			var clientObj = JSON.parse(this.getParameter('sysparm_obj'));
			var instanceGR = new GlideRecord('sys_update_set_source');
			if(instanceGR.get(clientObj.instance)){
				var instance = instanceGR.getValue('url').split('.')[0].split('https://')[1];
				var endpoint = "http://"+ instance +".service-now.com/";
				endpoint += "api/now/table/sc_catalog";
				endpoint += "?sysparm_query=ORDERBYtitle";
				endpoint += "&sysparm_fields=title,sys_id";
				var response = this._callViaREST({
					method: "get",
					endpoint: endpoint,
					requestBody: '',
				});
				returnObj = response.responseBody;
			} else {
				returnObj.errorMsg = 'Error looking up other instance.';
			}
			return JSON.stringify(returnObj);
		} catch(e) {
			return(JSON.stringify(e));
		}
	},
	getCategories: function() {
		try {
			var returnObj = {
				"_status": "started",
				"_sysparm_obj": this.getParameter('sysparm_obj')
			};
			var clientObj = JSON.parse(this.getParameter('sysparm_obj'));
			var instanceGR = new GlideRecord('sys_update_set_source');
			if(instanceGR.get(clientObj.instance)){
				var instance = instanceGR.getValue('url').split('.')[0].split('https://')[1];
				var endpoint = "http://"+ instance +".service-now.com/";
				endpoint += "api/now/table/sc_category";
				endpoint += "?sysparm_query=sc_catalog.sys_id=" + clientObj.catalog;
				endpoint += "%5EORDERBYtitle";
				endpoint += "&sysparm_fields=title,sys_id";
				returnObj.endpoint = endpoint;
				var response = this._callViaREST({
					method: "get",
					endpoint: endpoint,
					requestBody: '',
				});
				returnObj = response.responseBody;
			} else {
				returnObj.errorMsg = 'Error looking up other instance.';
			}
			return JSON.stringify(returnObj);
		} catch(e) {
			return(JSON.stringify(e));
		}
	},
	type: 'makeItem'
});]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>jace.benson@protonmail.com</sys_created_by>
        <sys_created_on>2018-08-01 21:49:54</sys_created_on>
        <sys_id>e342a0eb0f2b5300fc69cdbce1050e44</sys_id>
        <sys_mod_count>39</sys_mod_count>
        <sys_name>makeItem</sys_name>
        <sys_package display_value="Glide Utils" source="x_8821_glide_utils">e46761ba0f521300fc69cdbce1050e46</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="Glide Utils">e46761ba0f521300fc69cdbce1050e46</sys_scope>
        <sys_update_name>sys_script_include_e342a0eb0f2b5300fc69cdbce1050e44</sys_update_name>
        <sys_updated_by>jace.benson@protonmail.com</sys_updated_by>
        <sys_updated_on>2018-08-02 02:54:50</sys_updated_on>
    </sys_script_include>
</record_update>
